# Sheriff Plugin System - Implementation Progress

## 2026-01-12: plugin-types and plugin-api-types

### Completed
- Created `packages/core/src/lib/plugin/plugin.ts` with `SheriffPlugin` interface
- Created `packages/core/src/lib/plugin/plugin-api.ts` with:
  - `SheriffPluginAPI` interface
  - `VerificationResult` interface
  - `FileViolations` interface
  - `DependencyViolationInfo` interface
  - `ProjectDataOptions` interface

### Notes for Next Developer
- These two tasks were completed together because `SheriffPlugin` imports `SheriffPluginAPI`
- The types are now defined but NOT yet exported from the package index
- Next priority tasks (in order):
  1. `plugin-errors` - Add SH-013, SH-014, SH-015 error types to user-error.ts
  2. `config-types` - Add `plugins?: SheriffPlugin[]` to configuration types
  3. `plugin-resolver` - Create findPluginByName and validatePlugin functions
- The `plugin-api.ts` imports `Configuration` from config but doesn't expose it directly - plugins get it via `getConfig()` method
- Build passes (`nx run core:build`), all 347 tests pass

### Files Created
- `packages/core/src/lib/plugin/plugin.ts`
- `packages/core/src/lib/plugin/plugin-api.ts`

---

## 2026-01-12: plugin-errors

### Completed
- Added plugin-specific error types to `packages/core/src/lib/error/user-error.ts`:
  - Extended `UserErrorCode` type with `SH-013`, `SH-014`, `SH-015`
  - Created `PluginNotFoundError` (SH-013) - thrown when plugin name not found in plugins array
  - Created `PluginInvalidError` (SH-014) - thrown when plugin missing required name/execute properties
  - Created `PluginExecutionError` (SH-015) - wraps errors thrown during plugin execution

### Notes for Next Developer
- These error classes are ready to be used by the plugin-resolver and plugin-command implementations
- All errors have JSDoc comments explaining their purpose
- `PluginExecutionError` accepts either an Error object or a string for flexibility
- Next priority tasks (in order):
  1. `config-types` - Add `plugins?: SheriffPlugin[]` to configuration types
  2. `plugin-resolver` - Create findPluginByName and validatePlugin functions (will use these errors)
  3. `plugin-api-factory` - Create factory for SheriffPluginAPI
- Build passes (`npx nx run-many --target=build`), all 347 tests pass

### Files Modified
- `packages/core/src/lib/error/user-error.ts`

---

## 2026-01-12: config-types

### Completed
- Added `plugins` property to configuration types:
  - Imported `SheriffPlugin` in `packages/core/src/lib/config/user-sheriff-config.ts`
  - Added `plugins?: SheriffPlugin[]` property to `UserSheriffConfig` with JSDoc documentation
  - Imported `SheriffPlugin` in `packages/core/src/lib/config/configuration.ts`
  - Added `'plugins'` to the `Omit` list so it remains optional (not made required via `Required<>`)
  - Added `plugins?: SheriffPlugin[]` property to the `Configuration` type intersection

### Notes for Next Developer
- The plugins property is now available in both config types
- Users can define plugins in their `sheriff.config.ts` like:
  ```typescript
  export const config: SheriffConfig = {
    modules: { ... },
    depRules: { ... },
    plugins: [new MyPlugin()]
  };
  ```
- Next priority tasks (in order):
  1. `plugin-resolver` - Create findPluginByName and validatePlugin functions
  2. `plugin-api-factory` - Create factory for SheriffPluginAPI
  3. `plugin-barrel` - Create plugin module barrel file (lib/plugin/index.ts)
- Build passes (`npx nx run core:build`), all 347 tests pass

### Files Modified
- `packages/core/src/lib/config/user-sheriff-config.ts`
- `packages/core/src/lib/config/configuration.ts`

---

## 2026-01-12: plugin-resolver

### Completed
- Created `packages/core/src/lib/plugin/plugin-resolver.ts` with:
  - `validatePlugin(plugin)` - Type guard that validates a plugin has required `name` (non-empty string) and `execute` (function) properties
  - `findPluginByName(name, plugins)` - Finds a plugin by name from the plugins array, with proper error handling

### Implementation Details
- `validatePlugin` uses TypeScript's `asserts` return type for type narrowing
- Handles edge cases: null/undefined plugins, empty arrays, plugins with invalid/missing properties
- Throws `PluginNotFoundError` (SH-013) when no matching plugin found
- Throws `PluginInvalidError` (SH-014) when plugin is malformed

### Notes for Next Developer
- The resolver is ready to be used by `plugin-command.ts` (future task)
- Next priority tasks (in order):
  1. `plugin-api-factory` - Create factory for SheriffPluginAPI (needed before plugin-command)
  2. `plugin-barrel` - Create plugin module barrel file (lib/plugin/index.ts)
  3. `get-plugins-helper` - Create helper to load plugins from config
- Build passes (`npx nx run core:build`), all 347 tests pass

### Files Created
- `packages/core/src/lib/plugin/plugin-resolver.ts`

---

## 2026-01-12: plugin-api-factory

### Completed
- Created `packages/core/src/lib/plugin/create-plugin-api.ts` with:
  - `createPluginAPI()` - Factory function that returns a `SheriffPluginAPI` implementation
  - `verifyForPlugin(entryFile?)` - Internal function that runs verification and returns `VerificationResult` without calling `process.exit`
  - `getProjectDataForPlugin(entryFile?, options?)` - Wrapper around `getProjectData` API
  - `getConfigForPlugin()` - Returns the parsed `Configuration` object from sheriff.config.ts
  - `log()` and `logError()` wired to `cli.log` and `cli.logError` respectively

### Implementation Details
- The `verifyForPlugin` function reuses the same logic from `verify.ts` but:
  - Returns a structured `VerificationResult` instead of logging to console
  - Does NOT call `process.exit()` - plugins handle their own exit behavior
  - Aggregates violations from all entry points into a single result
- `getProjectDataForPlugin` uses `getEntriesFromCliOrConfig` with `runInit=false` to get entry info, then calls the existing `getProjectData` function
- `getConfigForPlugin` leverages `getEntriesFromCliOrConfig` which parses the config internally

### Notes for Next Developer
- The API factory is now ready to be used by `plugin-command.ts`
- The `verify()` method iterates over all project entries (supporting monorepo configs with multiple entry points)
- Violations are keyed by relative file path for consistency with other parts of the codebase
- Next priority tasks (in order):
  1. `plugin-barrel` - Create plugin module barrel file (lib/plugin/index.ts)
  2. `get-plugins-helper` - Create helper to load plugins from config
  3. `async-error-handler` - Add async error handling for plugin execution
- Build passes (`npx nx run core:build`), all 347 tests pass

### Files Created
- `packages/core/src/lib/plugin/create-plugin-api.ts`

---

## 2026-01-12: plugin-barrel

### Completed
- Created `packages/core/src/lib/plugin/index.ts` as the barrel file for the plugin module
- Re-exported all plugin system components:
  - `SheriffPlugin` from `./plugin`
  - `SheriffPluginAPI`, `VerificationResult`, `FileViolations`, `DependencyViolationInfo`, `ProjectDataOptions` from `./plugin-api`
  - `findPluginByName`, `validatePlugin` from `./plugin-resolver`
  - `createPluginAPI` from `./create-plugin-api`

### Implementation Details
- Added comprehensive JSDoc module documentation with usage examples
- Exports organized by category: interface, API types, resolver functions, factory
- No circular dependency issues confirmed via successful build

### Notes for Next Developer
- All plugin types and functions are now importable from a single location: `lib/plugin`
- This barrel file enables the `public-exports` task to export from the package index
- Next priority tasks (in order):
  1. `get-plugins-helper` - Create helper to load plugins from config
  2. `async-error-handler` - Add async error handling for plugin execution
  3. `plugin-command` - Create plugin command executor
- Build passes (`npm run build:all`), all 347 tests pass, lint passes

### Files Created
- `packages/core/src/lib/plugin/index.ts`

---

## 2026-01-12: get-plugins-helper

### Completed
- Created `packages/core/src/lib/cli/internal/get-plugins.ts` with:
  - `getPlugins()` function that loads and returns plugins from sheriff.config.ts
  - Returns `SheriffPlugin[]` from the configuration
  - Returns empty array when sheriff.config.ts doesn't exist
  - Returns empty array when plugins property is undefined
  - Handles config parsing errors gracefully (returns empty array)

### Implementation Details
- Uses existing `parseConfig` function from `config/parse-config.ts` to parse the config
- Uses `getFs()` for filesystem operations (supports virtual fs for testing)
- Leverages the optional `plugins` property added to `Configuration` type
- Wrapped in try/catch to gracefully handle any parsing errors

### Test Coverage
- Created comprehensive test suite in `packages/core/src/lib/cli/tests/get-plugins.spec.ts`
- Tests cover all acceptance criteria:
  - Returns empty array when no config file exists
  - Returns empty array when plugins property is undefined
  - Returns plugins array from config correctly
  - Returns empty array when plugins array is empty
  - Handles configs with plugins property set

### Notes for Next Developer
- The `getPlugins()` function is ready to be used by `cli/main.ts` for plugin discovery
- Next priority tasks (in order):
  1. `async-error-handler` - Add async error handling for plugin execution
  2. `plugin-command` - Create plugin command executor
  3. `cli-main-integration` - Integrate plugin system into main CLI
- Build passes (`npm run build:all`), all 352 tests pass (5 new tests), lint passes

### Files Created
- `packages/core/src/lib/cli/internal/get-plugins.ts`
- `packages/core/src/lib/cli/tests/get-plugins.spec.ts`

---

## 2026-01-13: plugin-command

### Completed
- Created `packages/core/src/lib/cli/plugin-command.ts` with:
  - `executePlugin(pluginName, args, plugins)` function that handles the complete plugin execution flow
  - Finds plugin by name using `findPluginByName`
  - Validates plugin structure using `validatePlugin`
  - Creates `SheriffPluginAPI` instance using `createPluginAPI`
  - Executes the plugin's `execute` method
  - Wraps any thrown errors in `PluginExecutionError`

### Implementation Details
- The function is async to support plugins that perform async operations
- Error handling is comprehensive:
  - `PluginNotFoundError` when no plugin matches the name
  - `PluginInvalidError` when plugin is malformed (missing name or execute)
  - `PluginExecutionError` wraps any error thrown during plugin execution
- The function receives pre-loaded plugins array (from `getPlugins()`)

### Test Coverage
- Created comprehensive test suite in `packages/core/src/lib/cli/tests/plugin-command.spec.ts`
- 17 tests covering all acceptance criteria:
  - Plugin discovery (finds correct plugin, handles not found)
  - Plugin validation (missing name, missing execute, invalid execute type)
  - Plugin execution (passes args, passes API object)
  - Error handling (wraps errors, includes plugin name, handles non-Error throws)
  - Successful execution resolution

### Notes for Next Developer
- The `executePlugin()` function is ready to be integrated into `cli/main.ts`
- Next priority tasks (in order):
  1. `cli-main-integration` - Integrate plugin system into main CLI (use `handleErrorAsync` and `executePlugin`)
  2. `public-exports` - Export plugin types from package index
  3. `e2e-plugin-test` - End-to-end test of plugin system
- Build passes (`npm run build:all`), all 374 tests pass (17 new tests), lint passes

### Files Created
- `packages/core/src/lib/cli/plugin-command.ts`
- `packages/core/src/lib/cli/tests/plugin-command.spec.ts`

### PRD Update
- Marked `async-error-handler` as passing (was already implemented by previous developer)
- Marked `plugin-command` as passing

---

## 2026-01-13: cli-main-integration

### Completed
- Integrated plugin system into the main CLI in `packages/core/src/lib/cli/main.ts`:
  - Defined `BUILTIN_COMMANDS` set with `init`, `verify`, `list`, `export`, `version`
  - Added `isBuiltinCommand(cmd)` helper function
  - Created `showHelp(plugins)` function that displays help with registered plugins
  - Created async `handlePluginOrHelp(cmd, args, plugins)` function for plugin/help routing
  - Refactored `main()` to handle built-in commands synchronously and plugins asynchronously
  - Built-in commands take precedence over plugins with the same name

### Implementation Details
- Main flow:
  1. Check if command is a built-in command → execute synchronously via `handleError()`
  2. Otherwise → load plugins via `getPlugins()`, handle asynchronously via `handleErrorAsync()`
     - If command matches a plugin name → execute plugin via `executePlugin()`
     - If no match → show help (with plugin list)
- Help output now includes "Plugins:" section when plugins are registered
- Plugins display with format: `sheriff <name>: <description>` (or just `sheriff <name>` if no description)

### Test Coverage
- Updated test suite in `packages/core/src/lib/cli/tests/main.spec.ts`
- 14 tests covering all acceptance criteria:
  - Help output (version, commands, unknown command shows help)
  - Plugin listing in help (with descriptions, without descriptions, empty list)
  - Plugin execution (correct plugin, passes args, provides API)
  - Plugin error handling (displays error message)
  - Built-in command precedence (verify works, list works, plugin named 'verify' not executed)

### Notes for Next Developer
- The plugin system is now fully integrated into the CLI
- Remaining tasks (in order):
  1. `public-exports` - Export plugin types from package index (so users can import types)
  2. `e2e-plugin-test` - End-to-end test of plugin system
- Build passes (`npm run build:all`), all 387 tests pass (14 tests in main.spec.ts, 13 new), lint passes

### Files Modified
- `packages/core/src/lib/cli/main.ts`
- `packages/core/src/lib/cli/tests/main.spec.ts`

### PRD Update
- Marked `cli-main-integration` as passing
